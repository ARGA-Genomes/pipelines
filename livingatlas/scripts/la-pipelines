#!/bin/bash
CMD=$(basename $0)

FIND_DOCOPTS=$(which docopts)
FIND_YQ=$(which yq)

if [[ -z $FIND_DOCOPTS ]]
then
    echo "ERROR: Please install docopts https://github.com/docopt/docopts an copy it in your PATH"
    exit 1
fi

if [[ -z $FIND_YQ ]]
then
    echo "ERROR: Please install yq, see https://github.com/mikefarah/yq"
    exit 1
fi

set -e # Stop on any fail

eval "$(docopts -V - -h - : "$@" <<EOF

LA-Pipelines data ingress utility.

Pipeline ingress steps:

    ┌───── do-all ──────────────────────────────────┐
    │                                               │
dwca-avro --> interpret --> uuid -->                │
     export-latlng --> sample --> sample-avro --> index

Usage:
  $CMD [options] dwca-avro (<dr>|all)
  $CMD [options] interpret (<dr>|all)
  $CMD [options] uuid (<dr>|all)
  $CMD [options] export-latlng (<dr>|all)
  $CMD [options] sample (<dr>|all)
  $CMD [options] sample-avro (<dr>|all)
  $CMD [options] index (<dr>|all)
  $CMD [options] do-all (<dr>|all)
  $CMD -h | --help
  $CMD -v | --version

Options:
  --config=<files>     Comma separated list of alternative la-pipeline yaml configurations (the last file has the highest precedence)
  --extra-args=<args>  Additional "arg1=values,arg2=value" to pass to pipeline options (highest precedence than yml values)
  --no-colors          No corolorize logs output
  -h --help            Show this help
  -v --version         Show version
  --debug              Debug $CMD
----
$CMD 0.1.1
Copyright (C) 2020 ALA Development Team
License MPL v 1.1
EOF
)"

# Enable logging
if ($debug) ; then verbosity=6; else verbosity=5; fi
source ./logging_lib.sh $verbosity $no_colors

log.info "Starting $CMD"

# Detect if we are in production or not
if [[ $PWD == "/usr/bin" ]] ; then PROD=true ; else PROD=false ; fi

# TODO: externalize this CONFIG_DIR in some way, ask other locations
if [[ $PROD = true ]] ; then CONFIG_DIR=/data/la-pipelines/config ; else CONFIG_DIR=../configs; fi

# Set default config locations for Production and Development
if [[ $PROD = false  && -z $config ]]; then config=$CONFIG_DIR/la-pipelines.yaml,$CONFIG_DIR/la-pipelines-local.yaml; fi
if [[ $PROD = true && -z $config ]]; then config=$CONFIG_DIR/la-pipelines.yaml,$CONFIG_DIR/configs/la-pipelines-local.yaml; fi

if [[ $PROD = false && $no_colors = false ]]; then logConfig=$PWD/../pipelines/src/main/resources/log4j-colorized.properties; fi
if [[ $PROD = false && $no_colors = true ]]; then logConfig=$PWD/../pipelines/src/main/resources/log4j.properties; fi
if [[ $PROD = true && $no_colors = false ]]; then logConfig=$CONFIG_DIR/log4j-colorized.properties; fi
if [[ $PROD = true && $no_colors = true ]]; then logConfig=$CONFIG_DIR/log4j.properties; fi

if [[ -n $dr && $dr != all && $dr != dr* ]]; then >&2 echo "ERROR: Wrong dataResource '$dr'. It should start with 'dr', like 'dr893'"; exit 1 ; fi

if [[ -n $extra_args ]] ; then
    # Convert arg1=val1,arg2=val2 into --arg1=val1 --arg2=val2
    ARGS=${extra_args//,/ \-\-}
    ARGS=--${ARGS}
else
    ARGS=
fi

log.info Config: $config
log.info Extra arguments: $ARGS
log.debug Logs without colors: $no_colors
log.debug log4j config: $logConfig

# TODO verify that confis exists
configList=${config//,/ }
log.debug Config list: $configList

for f in $configList $logConfig
do
    if [[ ! -f $f ]] ; then log.error File $f doesn\'t exits ; exit 1; fi
done

function getConf() {
    val=
    for i in $configList
    do
        valTmp=$(yq r $i $1)
        if [[ -n $valTmp ]] ; then val=$valTmp; fi
    done
    echo $val
}

log.debug Target $(getConf general.targetPath)

PIPELINES_JAR=$(eval echo $(getConf java.PIPELINES_JAR))
SPARK_TMP=$(getConf spark.SPARK_TMP)
log.debug Using $PIPELINES_JAR
log.debug Using $SPARK_TMP

#if ( $debug) ; then EXTRA_JVM_ARGS="-Dlog4j.debug"; fi
EXTRA_JVM_ARGS="$EXTRA_JVM_ARGS -Dlog4j.configuration=file://$logConfig"
log.debug EXTRA_JVM_ARGS: $EXTRA_JVM_ARGS

if ($do_all || $dwca_avro) ; then
    log.info "Ingest DwCA - Converts DwCA to verbatim.arvo file."
    dwca_dir="/data/biocache-load/$dr/$dr.zip"

    if [[ ! -f  $dwca_dir ]]
    then
        dwca_dir="/data/biocache-load/$dr.zip"
    fi

    if [[ ! -f  $dwca_dir ]]
    then
        dwca_dir="/data/biocache-load/$dr.zip"
        echo "$dwca_dir does not exists on your filesystem."
        exit 1
    fi

    java $EXTRA_JVM_ARGS -Dspark.local.dir=$SPARK_TMP \
         -cp $PIPELINES_JAR au.org.ala.pipelines.beam.ALADwcaToVerbatimPipeline \
         --datasetId=$dr \
         --config=$config $ARGS
fi

if ($interpret || $do_all); then
    echo ./interpret-spark-embedded.sh $dr
fi

if ($uuid || $do_all); then
    echo ./uuid-spark-embedded.sh $dr
fi

if ($export_latlng || $do_all); then
    echo ./export-latlng.sh $dr
fi

if ($sample || $do_all); then
    echo ./sample.sh $dr
fi

if ($sample_avro || $do_all); then
    echo ./sample-avro-embedded.sh $dr
fi

if ($index || $do_all); then
    echo ./index-java $dr
    echo ./index-spark-cluster $dr
    echo ./index-spark-embedded $dr
fi
